<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Target Realistis Saham</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
    }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
        Target Realistis Saham
      </h1>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal <span
              class="text-red-500">*</span></label>
          <input type="date" id="tanggal" lang="id-ID"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Emiten <span class="text-red-500">*</span></label>
          <input type="text" id="emiten" placeholder="BBCA"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Broker <span class="text-red-500">*</span></label>
          <input type="text" id="broker" placeholder="AS"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Buy Lot <span
              class="text-red-500">*</span></label>
          <input type="number" id="buyLot" placeholder="100000"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Buy Avg <span
              class="text-red-500">*</span></label>
          <input type="number" id="buyAvg" placeholder="216.4"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tick Size</label>
          <input type="text" id="tickSize" disabled placeholder="Auto"
            class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bid Terendah <span
              class="text-red-500">*</span></label>
          <input type="number" id="bidTerendah" placeholder="200"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Offer Tertinggi <span
              class="text-red-500">*</span></label>
          <input type="number" id="offerTertinggi" placeholder="250"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Papan</label>
        <input type="text" id="jumlahPapan" disabled placeholder="Auto"
          class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Bid (lot)</label>
          <input type="number" id="totalBid" placeholder="85000"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Offer (lot)</label>
          <input type="number" id="totalOffer" placeholder="65000"
            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="flex gap-3 flex-wrap">
        <button id="btnCalculate"
          class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="4" y="2" width="16" height="20" rx="2" />
            <line x1="8" y1="6" x2="16" y2="6" />
            <line x1="8" y1="10" x2="16" y2="10" />
            <line x1="8" y1="14" x2="16" y2="14" />
            <line x1="8" y1="18" x2="16" y2="18" />
          </svg>
          Hitung
        </button>
        <button id="btnReset"
          class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors">
          Reset
        </button>
      </div>

      <p class="text-xs text-gray-500 mt-4"><span class="text-red-500">*</span> Wajib diisi</p>
    </div>

    <div id="historySection" class="hidden bg-white rounded-2xl shadow-xl p-6 md:p-8"></div>

    <footer class="mt-8 text-center text-sm text-gray-600 pb-4">
      <p class="mb-2">
        Formula by
        <a href="https://x.com/adisucippto" target="_blank" rel="noopener noreferrer"
          class="text-blue-600 hover:text-blue-700 font-medium transition-colors">adimollogy</a>
        <span class="mx-1">&</span>
        <span class="font-medium">buruhIHSG</span>
      </p>
      <p class="text-gray-500">
        Made with <span class="text-red-500">‚ù§</span> by
        <a href="https://x.com/ahfasxp" target="_blank" rel="noopener noreferrer"
          class="font-medium text-gray-700 hover:text-blue-600 transition-colors">Ahfas</a>
      </p>
    </footer>
  </div>

  <script>
    let history = [];
    let expandedItems = {};

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setTodayDate();
      loadHistory();
      setupEventListeners();
    });

    function setTodayDate() {
      document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
    }

    function setupEventListeners() {
      document.getElementById('buyAvg').addEventListener('input', handleBuyAvgChange);
      document.getElementById('emiten').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
      document.getElementById('broker').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
      document.getElementById('offerTertinggi').addEventListener('input', updateJumlahPapan);
      document.getElementById('bidTerendah').addEventListener('input', updateJumlahPapan);
      document.getElementById('btnCalculate').addEventListener('click', handleCalculate);
      document.getElementById('btnReset').addEventListener('click', handleReset);
    }

    function handleBuyAvgChange(e) {
      const buyAvg = parseFloat(e.target.value);
      document.getElementById('tickSize').value = buyAvg ? `${getTickSize(buyAvg)} poin` : '';
      updateJumlahPapan();
    }

    function updateJumlahPapan() {
      const buyAvg = parseFloat(document.getElementById('buyAvg').value) || 0;
      const offerTertinggi = parseFloat(document.getElementById('offerTertinggi').value) || 0;
      const bidTerendah = parseFloat(document.getElementById('bidTerendah').value) || 0;

      if (buyAvg && offerTertinggi && bidTerendah && offerTertinggi > bidTerendah) {
        const tick = getTickSize(buyAvg);
        const jumlahPapan = ((offerTertinggi - bidTerendah) / tick) + 1;
        document.getElementById('jumlahPapan').value = formatNumber(jumlahPapan);
      } else {
        document.getElementById('jumlahPapan').value = '';
      }
    }

    function getTickSize(price) {
      const p = Number(price) || 0;
      if (p <= 200) return 1;
      if (p <= 500) return 2;
      if (p <= 2000) return 5;
      if (p <= 5000) return 10;
      return 25;
    }

    function formatNumber(num) {
      if (isNaN(num) || num === null) return '0';
      const rounded = Math.round(num * 100) / 100;
      return Number(rounded).toLocaleString('id-ID', {
        minimumFractionDigits: rounded === Math.floor(rounded) ? 0 : 2,
        maximumFractionDigits: 2
      });
    }

    function round2(num) {
      return Math.round(num * 100) / 100;
    }

    function handleCalculate() {
      const tanggal = document.getElementById('tanggal').value;
      const emiten = document.getElementById('emiten').value.trim();
      const broker = document.getElementById('broker').value.trim();
      const buyLot = Number(document.getElementById('buyLot').value) || 0;
      const buyAvg = Number(document.getElementById('buyAvg').value) || 0;
      const bidTerendah = Number(document.getElementById('bidTerendah').value) || 0;
      const offerTertinggi = Number(document.getElementById('offerTertinggi').value) || 0;
      const totalBid = Number(document.getElementById('totalBid').value) || 0;
      const totalOffer = Number(document.getElementById('totalOffer').value) || 0;

      // Validasi semua field wajib diisi
      if (!tanggal) {
        alert('Tanggal harus diisi');
        return;
      }
      if (!emiten) {
        alert('Emiten harus diisi');
        return;
      }
      if (!broker) {
        alert('Broker harus diisi');
        return;
      }
      if (!buyLot || buyLot <= 0) {
        alert('Buy Lot harus diisi dengan nilai yang valid');
        return;
      }
      if (!buyAvg || buyAvg <= 0) {
        alert('Buy Avg harus diisi dengan nilai yang valid');
        return;
      }
      if (!bidTerendah || bidTerendah <= 0) {
        alert('Bid Terendah harus diisi dengan nilai yang valid');
        return;
      }
      if (!offerTertinggi || offerTertinggi <= 0) {
        alert('Offer Tertinggi harus diisi dengan nilai yang valid');
        return;
      }
      if (offerTertinggi <= bidTerendah) {
        alert('Offer Tertinggi harus lebih besar dari Bid Terendah');
        return;
      }

      const tick = getTickSize(buyAvg);
      const jumlahPapan = ((offerTertinggi - bidTerendah) / tick) + 1;
      const rataPerPapan = (totalBid + totalOffer) / jumlahPapan;
      const papanCountHigh = rataPerPapan > 0 ? (buyLot / rataPerPapan) : 0;
      const papanCountLow = papanCountHigh / 2;
      const fivePercent = buyAvg * 0.05;

      const targetHigh = buyAvg + fivePercent + (papanCountHigh * tick);
      const targetLow = buyAvg + fivePercent + (papanCountLow * tick);

      const percentLow = ((targetLow - buyAvg) / buyAvg) * 100;
      const percentHigh = ((targetHigh - buyAvg) / buyAvg) * 100;

      const result = {
        timestamp: new Date().toISOString(),
        tanggal,
        dateDisplay: tanggal ? new Date(tanggal + 'T00:00:00').toLocaleDateString('id-ID', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        }) : '-',
        emiten,
        broker,
        buyLot: round2(buyLot),
        buyAvg: round2(buyAvg),
        bidTerendah: round2(bidTerendah),
        offerTertinggi: round2(offerTertinggi),
        totalBid: round2(totalBid),
        totalOffer: round2(totalOffer),
        jumlahPapan: round2(jumlahPapan),
        rataPerPapan: round2(rataPerPapan),
        papanCountHigh: round2(papanCountHigh),
        papanCountLow: round2(papanCountLow),
        tick,
        fivePercent: round2(fivePercent),
        targetHigh: round2(targetHigh),
        targetLow: round2(targetLow),
        percentLow: round2(percentLow),
        percentHigh: round2(percentHigh)
      };

      saveToHistory(result);
    }

    function handleReset() {
      setTodayDate();
      ['emiten', 'broker', 'buyLot', 'buyAvg', 'bidTerendah', 'offerTertinggi', 'jumlahPapan', 'totalBid', 'totalOffer', 'tickSize']
        .forEach(id => document.getElementById(id).value = '');
    }

    function loadHistory() {
      try {
        const stored = localStorage.getItem('calc_history');
        history = stored ? JSON.parse(stored) : [];
        history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderHistory();
      } catch (e) {
        console.error('Error loading history:', e);
        history = [];
        renderHistory();
      }
    }

    function saveToHistory(result) {
      try {
        history.unshift(result);
        localStorage.setItem('calc_history', JSON.stringify(history));
        renderHistory();
      } catch (e) {
        console.error('Failed to save history:', e);
        alert('Gagal menyimpan ke history: ' + e.message);
      }
    }

    function renderHistory() {
      const container = document.getElementById('historySection');

      if (history.length === 0) {
        container.classList.add('hidden');
        return;
      }

      const historyHTML = history.map(result => {
        const isExpanded = expandedItems[result.timestamp];
        return `
      <div class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all bg-white">
        <div class="p-5">
          <div class="flex justify-between items-start mb-4 gap-3">
            <div class="flex-1 min-w-0">
              <h3 class="text-xl font-bold text-gray-800 truncate">${result.emiten}</h3>
              <p class="text-xs text-gray-500 mt-1 truncate">${result.dateDisplay} ‚Ä¢ Broker ${result.broker}</p>
            </div>
            <div class="flex gap-2 flex-shrink-0">
              <button onclick="handleCopy('${result.timestamp}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Salin detail">
                <svg id="copyIcon-${result.timestamp}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
              </button>
              <button onclick="handleDeleteHistory('${result.timestamp}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Hapus">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-4">
            <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-lg p-4 min-w-0">
              <p class="text-xs text-gray-600 mb-1">üéØ Target LOW</p>
              <p class="text-lg sm:text-xl md:text-2xl font-bold text-green-600 break-all">Rp ${formatNumber(result.targetLow)}</p>
              <p class="text-xs sm:text-sm font-semibold text-green-600 mt-1 break-all">+${formatNumber(result.percentLow)}%</p>
            </div>
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-4 min-w-0">
              <p class="text-xs text-gray-600 mb-1">üöÄ Target HIGH</p>
              <p class="text-lg sm:text-xl md:text-2xl font-bold text-blue-600 break-all">Rp ${formatNumber(result.targetHigh)}</p>
              <p class="text-xs sm:text-sm font-semibold text-blue-600 mt-1 break-all">+${formatNumber(result.percentHigh)}%</p>
            </div>
          </div>

          <button onclick="toggleExpand('${result.timestamp}')" class="w-full text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-50 font-medium flex items-center justify-center gap-2 py-3 border-t border-gray-200 transition-colors">
            <span>${isExpanded ? 'Sembunyikan' : 'Lihat'} detail perhitungan</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${isExpanded ? 'rotate-180' : ''}">
              <polyline points="6 9 12 15 18 9"/>
            </svg>
          </button>
        </div>
        
        <div class="bg-gray-50 border-t border-gray-200 ${isExpanded ? '' : 'hidden'}">
          <div class="p-5 space-y-4">
            <div>
              <h4 class="text-sm font-semibold text-gray-700 mb-2">Data Input</h4>
              <div class="overflow-x-auto">
                <div class="grid grid-cols-2 gap-x-4 gap-y-1.5 text-xs min-w-max">
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Buy Average:</span><span class="font-medium ml-2">Rp ${formatNumber(result.buyAvg)}</span></div>
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Buy Lot:</span><span class="font-medium ml-2">${formatNumber(result.buyLot)} lot</span></div>
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Bid Terendah:</span><span class="font-medium ml-2">Rp ${formatNumber(result.bidTerendah)}</span></div>
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Offer Tertinggi:</span><span class="font-medium ml-2">Rp ${formatNumber(result.offerTertinggi)}</span></div>
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Total Bid:</span><span class="font-medium ml-2">${formatNumber(result.totalBid)} lot</span></div>
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Total Offer:</span><span class="font-medium ml-2">${formatNumber(result.totalOffer)} lot</span></div>
                  <div class="flex justify-between whitespace-nowrap"><span class="text-gray-600">Tick Size:</span><span class="font-medium ml-2">${result.tick} poin</span></div>
                </div>
              </div>
            </div>

            <div class="border-t border-gray-200 pt-4">
              <h4 class="text-sm font-semibold text-gray-700 mb-3">Proses Perhitungan</h4>
              
              <div class="space-y-3 text-xs">
                <div class="bg-white rounded-lg p-3 border border-gray-200">
                  <p class="font-medium text-gray-700 mb-1">1. Jumlah Papan Harga</p>
                  <div class="overflow-x-auto">
                    <p class="text-gray-600 whitespace-nowrap">= ((Offer Tertinggi - Bid Terendah) / Tick Size) + 1</p>
                    <p class="text-gray-600 whitespace-nowrap">= ((${formatNumber(result.offerTertinggi)} - ${formatNumber(result.bidTerendah)}) / ${result.tick}) + 1</p>
                  </div>
                  <p class="font-semibold text-blue-600 mt-1 break-all">= ${formatNumber(result.jumlahPapan)} papan</p>
                </div>

                <div class="bg-white rounded-lg p-3 border border-gray-200">
                  <p class="font-medium text-gray-700 mb-1">2. Rata-rata Per Papan</p>
                  <div class="overflow-x-auto">
                    <p class="text-gray-600 whitespace-nowrap">= (Total Bid + Total Offer) / Jumlah Papan</p>
                    <p class="text-gray-600 whitespace-nowrap">= (${formatNumber(result.totalBid)} + ${formatNumber(result.totalOffer)}) / ${formatNumber(result.jumlahPapan)}</p>
                  </div>
                  <p class="font-semibold text-blue-600 mt-1 break-all">= ${formatNumber(result.rataPerPapan)} lot/papan</p>
                </div>

                <div class="bg-white rounded-lg p-3 border border-gray-200">
                  <p class="font-medium text-gray-700 mb-1">3. Papan yang Terdorong</p>
                  <div class="overflow-x-auto">
                    <p class="text-gray-600 whitespace-nowrap">= Buy Lot / Rata Per Papan</p>
                    <p class="text-gray-600 mb-1 whitespace-nowrap">= ${formatNumber(result.buyLot)} / ${formatNumber(result.rataPerPapan)}</p>
                  </div>
                  <p class="font-semibold text-green-600 break-all">HIGH: ${formatNumber(result.papanCountHigh)} papan</p>
                  <p class="font-semibold text-green-600 break-all">LOW: ${formatNumber(result.papanCountLow)} papan (50% dari HIGH)</p>
                </div>

                <div class="bg-white rounded-lg p-3 border border-gray-200">
                  <p class="font-medium text-gray-700 mb-1">4. Baseline (5% dari Buy Avg)</p>
                  <div class="overflow-x-auto">
                    <p class="text-gray-600 whitespace-nowrap">= ${formatNumber(result.buyAvg)} √ó 5%</p>
                  </div>
                  <p class="font-semibold text-blue-600 mt-1 break-all">= ${formatNumber(result.fivePercent)} poin</p>
                </div>

                <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-lg p-3 border-2 border-green-300">
                  <p class="font-medium text-gray-800 mb-1">üéØ TARGET LOW</p>
                  <div class="overflow-x-auto">
                    <p class="text-gray-700 whitespace-nowrap">= Buy Avg + Baseline + (Papan Terdorong √ó Tick)</p>
                    <p class="text-gray-700 whitespace-nowrap">= ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + (${formatNumber(result.papanCountLow)} √ó ${result.tick})</p>
                    <p class="text-gray-700 whitespace-nowrap">= ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountLow * result.tick)}</p>
                  </div>
                  <p class="text-lg sm:text-xl font-bold text-green-600 mt-2 break-all">= Rp ${formatNumber(result.targetLow)}</p>
                  <p class="text-xs sm:text-sm font-semibold text-green-600 break-all">(+${formatNumber(result.percentLow)}%)</p>
                </div>

                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-lg p-3 border-2 border-blue-300">
                  <p class="font-medium text-gray-800 mb-1">üöÄ TARGET HIGH</p>
                  <div class="overflow-x-auto">
                    <p class="text-gray-700 whitespace-nowrap">= Buy Avg + Baseline + (Papan Terdorong √ó Tick)</p>
                    <p class="text-gray-700 whitespace-nowrap">= ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + (${formatNumber(result.papanCountHigh)} √ó ${result.tick})</p>
                    <p class="text-gray-700 whitespace-nowrap">= ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountHigh * result.tick)}</p>
                  </div>
                  <p class="text-lg sm:text-xl font-bold text-blue-600 mt-2 break-all">= Rp ${formatNumber(result.targetHigh)}</p>
                  <p class="text-xs sm:text-sm font-semibold text-blue-600 break-all">(+${formatNumber(result.percentHigh)}%)</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    `;
      }).join('');

      container.innerHTML = `
    <div class="flex justify-between items-center mb-4 gap-3 flex-wrap">
      <h2 class="text-2xl font-bold text-gray-800">Hasil Perhitungan</h2>
      <button onclick="handleClearAllHistory()" class="text-sm bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-lg transition-colors flex-shrink-0">
        Hapus semua
      </button>
    </div>
    <p class="text-sm text-gray-500 mb-4">Riwayat perhitungan tersimpan otomatis</p>
    <div class="space-y-4">${historyHTML}</div>
  `;
      container.classList.remove('hidden');
    }

    function toggleExpand(timestamp) {
      expandedItems[timestamp] = !expandedItems[timestamp];
      renderHistory();
    }

    function handleCopy(timestamp) {
      const result = history.find(r => r.timestamp === timestamp);
      if (!result) return;

      const text = `TARGET REALISTIS SAHAM ${result.emiten}
${result.dateDisplay} | Broker ${result.broker}

üéØ TARGET LOW: Rp ${formatNumber(result.targetLow)} (+${formatNumber(result.percentLow)}%)
üöÄ TARGET HIGH: Rp ${formatNumber(result.targetHigh)} (+${formatNumber(result.percentHigh)}%)

DATA:
- Buy Avg: Rp ${formatNumber(result.buyAvg)}
- Buy Lot: ${formatNumber(result.buyLot)} lot
- Bid: Rp ${formatNumber(result.bidTerendah)} | Offer: Rp ${formatNumber(result.offerTertinggi)}
- Total Bid: ${formatNumber(result.totalBid)} lot | Total Offer: ${formatNumber(result.totalOffer)} lot
- Tick Size: ${result.tick} poin

PERHITUNGAN:
1. Jumlah Papan = ${formatNumber(result.jumlahPapan)} papan
2. Rata per Papan = ${formatNumber(result.rataPerPapan)} lot
3. Papan Terdorong: HIGH ${formatNumber(result.papanCountHigh)} | LOW ${formatNumber(result.papanCountLow)}
4. Baseline (5%) = ${formatNumber(result.fivePercent)} poin

RUMUS:
Target = Buy Avg + Baseline + (Papan Terdorong √ó Tick)
LOW = ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + (${formatNumber(result.papanCountLow)} √ó ${result.tick}) = Rp ${formatNumber(result.targetLow)}
HIGH = ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + (${formatNumber(result.papanCountHigh)} √ó ${result.tick}) = Rp ${formatNumber(result.targetHigh)}

Formula: adimollogy & buruhIHSG | Dev: Ahfas`;

      navigator.clipboard.writeText(text);

      const icon = document.getElementById(`copyIcon-${result.timestamp}`);
      if (icon) {
        icon.innerHTML = '<polyline points="20 6 9 17 4 12"/>';
        setTimeout(() => {
          icon.innerHTML = '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>';
        }, 2000);
      }
    }

    function handleDeleteHistory(timestamp) {
      try {
        history = history.filter(item => item.timestamp !== timestamp);
        localStorage.setItem('calc_history', JSON.stringify(history));
        renderHistory();
      } catch (e) {
        console.error('Failed to delete history item:', e);
      }
    }

    function handleClearAllHistory() {
      if (!confirm('Hapus semua history?')) return;

      try {
        localStorage.removeItem('calc_history');
        history = [];
        renderHistory();
      } catch (e) {
        console.error('Failed to clear history:', e);
      }
    }
  </script>
</body>

</html>