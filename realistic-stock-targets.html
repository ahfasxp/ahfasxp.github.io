<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculator Target Realistis â€” Saham</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {}
      }
    }
  </script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
        Calculator Target Realistis â€” Saham
      </h1>
      <p class="text-gray-600 text-sm">Target = BuyAvg + 5% + (Papan Ã— TickSize) | Tick BEI</p>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
          <input type="date" id="tanggal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Emiten</label>
          <input type="text" id="emiten" placeholder="BBCA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
          <input type="text" id="broker" placeholder="AS" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Buy Lot</label>
          <input type="number" id="buyLot" placeholder="100000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Buy Avg*</label>
          <input type="number" id="buyAvg" placeholder="216.4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tick Size</label>
          <input type="text" id="tickSize" readonly disabled="true" placeholder="Auto" class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bid Terendah</label>
          <input type="number" id="arb" placeholder="250" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Offer Tertinggi</label>
          <input type="number" id="ara" placeholder="200" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Papan</label>
        <input type="number" id="jumlahPapan" readonly disabled="true" placeholder="Auto" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-600">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Bid (lot)</label>
          <input type="number" id="totalBid" placeholder="85000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Offer (lot)</label>
          <input type="number" id="totalOffer" placeholder="65000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="flex gap-3">
        <button id="btnCalculate" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
          Hitung
        </button>
        <button id="btnReset" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors">
          Reset
        </button>
      </div>

      <p class="text-xs text-gray-500 mt-4">* Buy Avg wajib diisi. Isi ARA & ARB ATAU Jumlah Papan.</p>
    </div>

    <div id="historySection" class="hidden bg-white rounded-2xl shadow-xl p-6 md:p-8"></div>
  </div>

  <script>
    let history = [];
    let expandedItems = {};

    window.addEventListener('DOMContentLoaded', () => {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('tanggal').value = today;
      
      loadHistory();
      
      document.getElementById('buyAvg').addEventListener('input', (e) => {
        const buyAvg = parseFloat(e.target.value);
        if (buyAvg) {
          document.getElementById('tickSize').value = getTickSize(buyAvg) + ' poin';
        } else {
          document.getElementById('tickSize').value = '';
        }
      });

      document.getElementById('emiten').addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });
      document.getElementById('broker').addEventListener('input', (e) => {
        e.target.value = e.target.value.toUpperCase();
      });

      document.getElementById('ara').addEventListener('input', updateJumlahPapan);
      document.getElementById('arb').addEventListener('input', updateJumlahPapan);

      document.getElementById('btnCalculate').addEventListener('click', handleCalculate);
      document.getElementById('btnReset').addEventListener('click', handleReset);
    });

    function loadHistory() {
      try {
        const stored = localStorage.getItem('calc_history');
        if (stored) {
          history = JSON.parse(stored);
          history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        } else {
          history = [];
        }
        renderHistory();
      } catch (e) {
        console.error('Error loading history:', e);
        history = [];
        renderHistory();
      }
    }

    function saveToHistory(result) {
      try {
        history.unshift(result);
        localStorage.setItem('calc_history', JSON.stringify(history));
        renderHistory();
      } catch (e) {
        console.error('Failed to save history:', e);
        alert('Gagal menyimpan ke history: ' + e.message);
      }
    }

    function getTickSize(price) {
      const p = Number(price) || 0;
      if (p <= 200) return 1;
      if (p <= 500) return 2;
      if (p <= 2000) return 5;
      if (p <= 5000) return 10;
      return 25;
    }

    function formatNumber(num) {
      if (isNaN(num) || num === null) return '0';
      const rounded = Math.round(num * 100) / 100;
      if (rounded === Math.floor(rounded)) {
        return Number(rounded).toLocaleString('id-ID', {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0
        });
      }
      return Number(rounded).toLocaleString('id-ID', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }

    function round2(num) {
      return Math.round(num * 100) / 100;
    }

    function updateJumlahPapan() {
      const buyAvgVal = Number(document.getElementById('buyAvg').value) || 0;
      const araVal = parseFloat(document.getElementById('ara').value) || 0;
      const arbVal = parseFloat(document.getElementById('arb').value) || 0;
      const jumlahPapanInput = document.getElementById('jumlahPapan');

      const tick = getTickSize(buyAvgVal);
      const jumlahPapan = ((araVal - arbVal) / tick) + 1;
      jumlahPapanInput.placeholder = `Auto: ${formatNumber(jumlahPapan)}`;
    }

    function handleCalculate() {
      const tanggalVal = document.getElementById('tanggal').value;
      const emitenVal = document.getElementById('emiten').value || '-';
      const brokerVal = document.getElementById('broker').value || '-';
      
      // Ambil nilai input (belum dibulatkan)
      const buyLotVal = Number(document.getElementById('buyLot').value) || 0;
      const buyAvgVal = Number(document.getElementById('buyAvg').value) || 0;
      const arbVal = Number(document.getElementById('arb').value) || 0;
      const araVal = Number(document.getElementById('ara').value) || 0;
      const totalBidVal = Number(document.getElementById('totalBid').value) || 0;
      const totalOfferVal = Number(document.getElementById('totalOffer').value) || 0;
      const jumlahPapanManual = Number(document.getElementById('jumlahPapan').value) || 0;

      if (!buyAvgVal || buyAvgVal <= 0) {
        alert('Buy Avg harus diisi dengan nilai yang valid');
        return;
      }

      let jumlahPapan = 0;
      let papanSource = 'auto';
      const tick = getTickSize(buyAvgVal);
      
      if (jumlahPapanManual > 0) {
        jumlahPapan = jumlahPapanManual;
        papanSource = 'manual';
      } else if (araVal > 0 && arbVal > 0 && araVal > arbVal) {
        jumlahPapan = ((araVal - arbVal) / tick) + 1;
        papanSource = 'auto';
      } else {
        alert('Offer Tertinggi harus lebih besar dari Bid Terendah');
        return;
      }

      // RUMUS: Rata per Papan = (Total Bid + Total Offer) / jumlahPapan
      const rataPerPapan = (totalBidVal + totalOfferVal) / jumlahPapan;

      // Jumlah papan yang terdorong = Buy Lot / Rata per Papan
      const papanCountHigh = rataPerPapan > 0 ? (buyLotVal / rataPerPapan) : 0;
      const papanCountLow = papanCountHigh / 2;
      
      // 5% dari Buy Avg
      const fivePercent = buyAvgVal * 0.05;
      
      // Points dari papan = Jumlah Papan Ã— Tick Size
      const pointsFromPapanHigh = papanCountHigh;
      const pointsFromPapanLow = papanCountLow;
      
      // Target = Buy Avg + 5% + Points dari Papan
      const targetHigh = buyAvgVal + fivePercent + pointsFromPapanHigh;
      const targetLow = buyAvgVal + fivePercent + pointsFromPapanLow;

      const percentLow = ((targetLow - buyAvgVal) / buyAvgVal) * 100;
      const percentHigh = ((targetHigh - buyAvgVal) / buyAvgVal) * 100;

      // Bulatkan semua hasil di akhir untuk konsistensi
      const result = {
        timestamp: new Date().toISOString(),
        tanggal: tanggalVal,
        dateDisplay: tanggalVal ? new Date(tanggalVal + 'T00:00:00').toLocaleDateString('id-ID', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        }) : '-',
        emiten: emitenVal,
        broker: brokerVal,
        buyLot: round2(buyLotVal),
        buyAvg: round2(buyAvgVal),
        arb: round2(arbVal),
        ara: round2(araVal),
        totalBid: round2(totalBidVal),
        totalOffer: round2(totalOfferVal),
        jumlahPapan: round2(jumlahPapan),
        papanSource,
        rataPerPapan: round2(rataPerPapan),
        papanCountHigh: round2(papanCountHigh),
        papanCountLow: round2(papanCountLow),
        tick,
        pointsFromPapanHigh: round2(pointsFromPapanHigh),
        pointsFromPapanLow: round2(pointsFromPapanLow),
        fivePercent: round2(fivePercent),
        targetHigh: round2(targetHigh),
        targetLow: round2(targetLow),
        percentLow: round2(percentLow),
        percentHigh: round2(percentHigh)
      };


      saveToHistory(result);
    }

    function handleReset() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('tanggal').value = today;
      document.getElementById('emiten').value = '';
      document.getElementById('broker').value = '';
      document.getElementById('buyLot').value = '';
      document.getElementById('buyAvg').value = '';
      document.getElementById('arb').value = '';
      document.getElementById('ara').value = '';
      document.getElementById('jumlahPapan').value = '';
      document.getElementById('totalBid').value = '';
      document.getElementById('totalOffer').value = '';
      document.getElementById('tickSize').value = '';
    }

    function renderHistory() {
      const container = document.getElementById('historySection');
      
      if (history.length === 0) {
        container.classList.add('hidden');
        return;
      }

      let html = `
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Hasil Perhitungan</h2>
          <button onclick="handleClearAllHistory()" class="text-sm bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-lg transition-colors">
            Hapus semua
          </button>
        </div>
        <p class="text-sm text-gray-500 mb-4">Riwayat perhitungan tersimpan otomatis</p>
        <div class="space-y-4">
      `;

      history.forEach((result, index) => {
        const isExpanded = expandedItems[result.timestamp];
        html += `
          <div class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all bg-white">
            <div class="p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-bold text-gray-800">${result.emiten}</h3>
                  <p class="text-xs text-gray-500 mt-1">${result.dateDisplay} â€¢ Broker ${result.broker}</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="handleCopy('${result.timestamp}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Salin detail">
                    <svg id="copyIcon-${result.timestamp}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                  <button onclick="handleDeleteHistory('${result.timestamp}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Hapus">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3">
                  <p class="text-xs text-gray-600 mb-1">ðŸŽ¯ Target LOW</p>
                  <p class="text-lg md:text-xl font-bold text-green-600 break-words">Rp ${formatNumber(result.targetLow)}</p>
                  <p class="text-xs text-gray-500 mt-1 break-words">${formatNumber(result.papanCountLow)} papan â€¢ <span class="font-semibold text-green-600">+${formatNumber(result.percentLow)}%</span></p>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3">
                  <p class="text-xs text-gray-600 mb-1">ðŸš€ Target HIGH</p>
                  <p class="text-lg md:text-xl font-bold text-blue-600 break-words">Rp ${formatNumber(result.targetHigh)}</p>
                  <p class="text-xs text-gray-500 mt-1 break-words">${formatNumber(result.papanCountHigh)} papan â€¢ <span class="font-semibold text-blue-600">+${formatNumber(result.percentHigh)}%</span></p>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">Buy Avg</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">Rp ${formatNumber(result.buyAvg)}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">Buy Lot</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">${formatNumber(result.buyLot)}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">Tick Size</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">${result.tick} poin</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">5% Profit</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">${formatNumber(result.fivePercent)}</p>
                </div>
              </div>
            </div>

            <button onclick="toggleExpand('${result.timestamp}')" class="w-full text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-50 font-medium flex items-center justify-center gap-2 py-3 border-t border-gray-200 transition-colors">
              <span>Detail perhitungan</span>
              <svg id="chevron-${result.timestamp}" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${isExpanded ? 'rotate-180' : ''}">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            
            <div id="details-${result.timestamp}" class="p-5 bg-gray-50 text-xs space-y-2 border-t border-gray-200 ${isExpanded ? '' : 'hidden'}">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Total Bid:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.totalBid)} lot</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Total Offer:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.totalOffer)} lot</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Jumlah Papan:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.jumlahPapan)}</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Rata/Papan:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.rataPerPapan)} lot</span>
                </div>
              </div>
              <div class="pt-3 mt-3 border-t border-gray-200 space-y-2">
                <p class="text-gray-700 break-words">
                  <span class="font-medium">Target LOW:</span> ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountLow)} = <span class="font-bold text-green-600">Rp ${formatNumber(result.targetLow)}</span>
                </p>
                <p class="text-gray-700 break-words">
                  <span class="font-medium">Target HIGH:</span> ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountHigh)} = <span class="font-bold text-blue-600">Rp ${formatNumber(result.targetHigh)}</span>
                </p>
              </div>
            </div>
          </div>
        `;
      });

      html += '</div>';
      container.innerHTML = html;
      container.classList.remove('hidden');
    }

    function toggleExpand(timestamp) {
      expandedItems[timestamp] = !expandedItems[timestamp];
      renderHistory();
    }

    function handleCopy(timestamp) {
      const result = history.find(r => r.timestamp === timestamp);
      
      if (!result) return;

      const details = [
        `Tanggal: ${result.dateDisplay}`,
        `Buy Avg: Rp ${formatNumber(result.buyAvg)}`,
        `Buy Lot: ${formatNumber(result.buyLot)} lot`,
        `Tick size: ${result.tick} poin`,
        ``,
        `Jumlah Papan: ${formatNumber(result.jumlahPapan)}`,
        `Total Bid: ${formatNumber(result.totalBid)} lot  |  Total Offer: ${formatNumber(result.totalOffer)} lot`,
        `Rata per papan = (Bid + Offer) / Jumlah Papan = ${formatNumber(result.rataPerPapan)} lot`,
        ``,
        `Papan terdorong = Buy Lot / Rata per Papan`,
        `  HIGH: ${formatNumber(result.papanCountHigh)} papan`,
        `  LOW: ${formatNumber(result.papanCountLow)} papan`,
        ``,
        `5% dari Buy Avg = ${formatNumber(result.fivePercent)} poin`,
        ``,
        `TARGET LOW:`,
        `  = ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountLow)}`,
        `  = Rp ${formatNumber(result.targetLow)} (+${formatNumber(result.percentLow)}%)`,
        ``,
        `TARGET HIGH:`,
        `  = ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountHigh)}`,
        `  = Rp ${formatNumber(result.targetHigh)} (+${formatNumber(result.percentHigh)}%)`
      ].join('\n');

      const text = `Target Realistis untuk ${result.emiten} (Broker ${result.broker}):\nLOW: Rp ${formatNumber(result.targetLow)} | HIGH: Rp ${formatNumber(result.targetHigh)}\n\n${details}`;

      navigator.clipboard.writeText(text);
      
      const icon = document.getElementById(`copyIcon-${result.timestamp}`);
      if (icon) {
        icon.innerHTML = '<polyline points="20 6 9 17 4 12"/>';
        setTimeout(() => {
          icon.innerHTML = '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>';
        }, 2000);
      }
    }

    function handleDeleteHistory(timestamp) {
      try {
        history = history.filter(item => item.timestamp !== timestamp);
        localStorage.setItem('calc_history', JSON.stringify(history));
        renderHistory();
      } catch (e) {
        console.error('Failed to delete history item:', e);
      }
    }

    function handleClearAllHistory() {
      if (!confirm('Hapus semua history?')) return;
      
      try {
        localStorage.removeItem('calc_history');
        history = [];
        renderHistory();
      } catch (e) {
        console.error('Failed to clear history:', e);
      }
    }
  </script>
</body>
</html>
