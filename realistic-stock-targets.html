<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Target Realistis Saham</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
    }
  </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <div class="text-center mb-6">
      <h1 class="text-3xl md:text-4xl font-bold text-gray-800 mb-2">
        Target Realistis Saham
      </h1>
    </div>

    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tanggal</label>
          <input type="date" id="tanggal" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Emiten</label>
          <input type="text" id="emiten" placeholder="BBCA" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Broker</label>
          <input type="text" id="broker" placeholder="AS" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Buy Lot</label>
          <input type="number" id="buyLot" placeholder="100000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Buy Avg*</label>
          <input type="number" id="buyAvg" placeholder="216.4" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Tick Size</label>
          <input type="text" id="tickSize" disabled placeholder="Auto" class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Bid Terendah</label>
          <input type="number" id="bidTerendah" placeholder="200" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Offer Tertinggi</label>
          <input type="number" id="offerTertinggi" placeholder="250" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="mb-4">
        <label class="block text-sm font-medium text-gray-700 mb-1">Jumlah Papan</label>
        <input type="text" id="jumlahPapan" disabled placeholder="Auto" class="w-full px-4 py-2 border border-gray-200 rounded-lg bg-gray-50 text-gray-600">
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Bid (lot)</label>
          <input type="number" id="totalBid" placeholder="85000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Total Offer (lot)</label>
          <input type="number" id="totalOffer" placeholder="65000" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
        </div>
      </div>

      <div class="flex gap-3">
        <button id="btnCalculate" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-6 rounded-lg transition-colors flex items-center justify-center gap-2">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="4" y="2" width="16" height="20" rx="2"/><line x1="8" y1="6" x2="16" y2="6"/><line x1="8" y1="10" x2="16" y2="10"/><line x1="8" y1="14" x2="16" y2="14"/><line x1="8" y1="18" x2="16" y2="18"/></svg>
          Hitung
        </button>
        <button id="btnReset" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-semibold py-3 px-6 rounded-lg transition-colors">
          Reset
        </button>
      </div>

      <p class="text-xs text-gray-500 mt-4">* Buy Avg wajib diisi. Isi Bid Terendah & Offer Tertinggi untuk auto calculate Jumlah Papan.</p>
    </div>

    <div id="historySection" class="hidden bg-white rounded-2xl shadow-xl p-6 md:p-8"></div>

    <footer class="mt-8 text-center text-sm text-gray-600 pb-4">
      <p class="mb-2">
        Formula by 
        <a href="https://x.com/adisucippto" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-700 font-medium transition-colors">adimollogy</a>
        <span class="mx-1">&</span>
        <span class="font-medium">buruhIHSG</span>
      </p>
      <p class="text-gray-500">
        Made with <span class="text-red-500">‚ù§</span> by 
        <a href="https://x.com/ahfasxp" target="_blank" rel="noopener noreferrer" class="font-medium text-gray-700 hover:text-blue-600 transition-colors">Ahfas</a>
      </p>
    </footer>
  </div>

  <script>
    let history = [];
    let expandedItems = {};

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      setTodayDate();
      loadHistory();
      setupEventListeners();
    });

    function setTodayDate() {
      document.getElementById('tanggal').value = new Date().toISOString().split('T')[0];
    }

    function setupEventListeners() {
      document.getElementById('buyAvg').addEventListener('input', handleBuyAvgChange);
      document.getElementById('emiten').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
      document.getElementById('broker').addEventListener('input', e => e.target.value = e.target.value.toUpperCase());
      document.getElementById('offerTertinggi').addEventListener('input', updateJumlahPapan);
      document.getElementById('bidTerendah').addEventListener('input', updateJumlahPapan);
      document.getElementById('btnCalculate').addEventListener('click', handleCalculate);
      document.getElementById('btnReset').addEventListener('click', handleReset);
    }

    function handleBuyAvgChange(e) {
      const buyAvg = parseFloat(e.target.value);
      document.getElementById('tickSize').value = buyAvg ? `${getTickSize(buyAvg)} poin` : '';
      updateJumlahPapan();
    }

    function updateJumlahPapan() {
      const buyAvg = parseFloat(document.getElementById('buyAvg').value) || 0;
      const offerTertinggi = parseFloat(document.getElementById('offerTertinggi').value) || 0;
      const bidTerendah = parseFloat(document.getElementById('bidTerendah').value) || 0;

      if (buyAvg && offerTertinggi && bidTerendah && offerTertinggi > bidTerendah) {
        const tick = getTickSize(buyAvg);
        const jumlahPapan = ((offerTertinggi - bidTerendah) / tick) + 1;
        document.getElementById('jumlahPapan').value = formatNumber(jumlahPapan);
      } else {
        document.getElementById('jumlahPapan').value = '';
      }
    }

    function getTickSize(price) {
      const p = Number(price) || 0;
      if (p <= 200) return 1;
      if (p <= 500) return 2;
      if (p <= 2000) return 5;
      if (p <= 5000) return 10;
      return 25;
    }

    function formatNumber(num) {
      if (isNaN(num) || num === null) return '0';
      const rounded = Math.round(num * 100) / 100;
      return Number(rounded).toLocaleString('id-ID', {
        minimumFractionDigits: rounded === Math.floor(rounded) ? 0 : 2,
        maximumFractionDigits: 2
      });
    }

    function round2(num) {
      return Math.round(num * 100) / 100;
    }

    function handleCalculate() {
      const tanggal = document.getElementById('tanggal').value;
      const emiten = document.getElementById('emiten').value || '-';
      const broker = document.getElementById('broker').value || '-';
      const buyLot = Number(document.getElementById('buyLot').value) || 0;
      const buyAvg = Number(document.getElementById('buyAvg').value) || 0;
      const bidTerendah = Number(document.getElementById('bidTerendah').value) || 0;
      const offerTertinggi = Number(document.getElementById('offerTertinggi').value) || 0;
      const totalBid = Number(document.getElementById('totalBid').value) || 0;
      const totalOffer = Number(document.getElementById('totalOffer').value) || 0;

      if (!buyAvg || buyAvg <= 0) {
        alert('Buy Avg harus diisi dengan nilai yang valid');
        return;
      }

      const tick = getTickSize(buyAvg);
      let jumlahPapan = 0;

      if (offerTertinggi > 0 && bidTerendah > 0 && offerTertinggi > bidTerendah) {
        jumlahPapan = ((offerTertinggi - bidTerendah) / tick) + 1;
      } else {
        alert('Offer Tertinggi harus lebih besar dari Bid Terendah');
        return;
      }

      const rataPerPapan = (totalBid + totalOffer) / jumlahPapan;
      const papanCountHigh = rataPerPapan > 0 ? (buyLot / rataPerPapan) : 0;
      const papanCountLow = papanCountHigh / 2;
      const fivePercent = buyAvg * 0.05;
      const targetHigh = buyAvg + fivePercent + papanCountHigh;
      const targetLow = buyAvg + fivePercent + papanCountLow;
      const percentLow = ((targetLow - buyAvg) / buyAvg) * 100;
      const percentHigh = ((targetHigh - buyAvg) / buyAvg) * 100;

      const result = {
        timestamp: new Date().toISOString(),
        tanggal,
        dateDisplay: tanggal ? new Date(tanggal + 'T00:00:00').toLocaleDateString('id-ID', {
          day: '2-digit',
          month: 'short',
          year: 'numeric'
        }) : '-',
        emiten,
        broker,
        buyLot: round2(buyLot),
        buyAvg: round2(buyAvg),
        bidTerendah: round2(bidTerendah),
        offerTertinggi: round2(offerTertinggi),
        totalBid: round2(totalBid),
        totalOffer: round2(totalOffer),
        jumlahPapan: round2(jumlahPapan),
        rataPerPapan: round2(rataPerPapan),
        papanCountHigh: round2(papanCountHigh),
        papanCountLow: round2(papanCountLow),
        tick,
        fivePercent: round2(fivePercent),
        targetHigh: round2(targetHigh),
        targetLow: round2(targetLow),
        percentLow: round2(percentLow),
        percentHigh: round2(percentHigh)
      };

      saveToHistory(result);
    }

    function handleReset() {
      setTodayDate();
      ['emiten', 'broker', 'buyLot', 'buyAvg', 'bidTerendah', 'offerTertinggi', 'jumlahPapan', 'totalBid', 'totalOffer', 'tickSize']
        .forEach(id => document.getElementById(id).value = '');
    }

    function loadHistory() {
      try {
        const stored = localStorage.getItem('calc_history');
        history = stored ? JSON.parse(stored) : [];
        history.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        renderHistory();
      } catch (e) {
        console.error('Error loading history:', e);
        history = [];
        renderHistory();
      }
    }

    function saveToHistory(result) {
      try {
        history.unshift(result);
        localStorage.setItem('calc_history', JSON.stringify(history));
        renderHistory();
      } catch (e) {
        console.error('Failed to save history:', e);
        alert('Gagal menyimpan ke history: ' + e.message);
      }
    }

    function renderHistory() {
      const container = document.getElementById('historySection');
      
      if (history.length === 0) {
        container.classList.add('hidden');
        return;
      }

      const historyHTML = history.map(result => {
        const isExpanded = expandedItems[result.timestamp];
        return `
          <div class="border border-gray-200 rounded-xl overflow-hidden hover:shadow-md transition-all bg-white">
            <div class="p-5">
              <div class="flex justify-between items-start mb-4">
                <div>
                  <h3 class="text-xl font-bold text-gray-800">${result.emiten}</h3>
                  <p class="text-xs text-gray-500 mt-1">${result.dateDisplay} ‚Ä¢ Broker ${result.broker}</p>
                </div>
                <div class="flex gap-2">
                  <button onclick="handleCopy('${result.timestamp}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors" title="Salin detail">
                    <svg id="copyIcon-${result.timestamp}" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg>
                  </button>
                  <button onclick="handleDeleteHistory('${result.timestamp}')" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors" title="Hapus">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                  </button>
                </div>
              </div>

              <div class="grid grid-cols-2 gap-3 mb-4">
                <div class="bg-gradient-to-br from-green-50 to-emerald-50 border border-green-200 rounded-lg p-3">
                  <p class="text-xs text-gray-600 mb-1">üéØ Target LOW</p>
                  <p class="text-lg md:text-xl font-bold text-green-600 break-words">Rp ${formatNumber(result.targetLow)}</p>
                  <p class="text-xs text-gray-500 mt-1 break-words">${formatNumber(result.papanCountLow)} papan ‚Ä¢ <span class="font-semibold text-green-600">+${formatNumber(result.percentLow)}%</span></p>
                </div>
                <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border border-blue-200 rounded-lg p-3">
                  <p class="text-xs text-gray-600 mb-1">üöÄ Target HIGH</p>
                  <p class="text-lg md:text-xl font-bold text-blue-600 break-words">Rp ${formatNumber(result.targetHigh)}</p>
                  <p class="text-xs text-gray-500 mt-1 break-words">${formatNumber(result.papanCountHigh)} papan ‚Ä¢ <span class="font-semibold text-blue-600">+${formatNumber(result.percentHigh)}%</span></p>
                </div>
              </div>

              <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">Buy Avg</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">Rp ${formatNumber(result.buyAvg)}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">Buy Lot</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">${formatNumber(result.buyLot)}</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">Tick Size</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">${result.tick} poin</p>
                </div>
                <div class="bg-gray-50 rounded-lg p-2.5">
                  <p class="text-xs text-gray-500 mb-1">5% Buy Avg</p>
                  <p class="text-sm font-semibold text-gray-800 break-words">${formatNumber(result.fivePercent)} poin</p>
                </div>
              </div>
            </div>

            <button onclick="toggleExpand('${result.timestamp}')" class="w-full text-sm text-gray-600 hover:text-gray-800 hover:bg-gray-50 font-medium flex items-center justify-center gap-2 py-3 border-t border-gray-200 transition-colors">
              <span>Detail perhitungan</span>
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="transition-transform ${isExpanded ? 'rotate-180' : ''}">
                <polyline points="6 9 12 15 18 9"/>
              </svg>
            </button>
            
            <div class="p-5 bg-gray-50 text-xs space-y-2 border-t border-gray-200 ${isExpanded ? '' : 'hidden'}">
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2">
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Total Bid:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.totalBid)} lot</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Total Offer:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.totalOffer)} lot</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Jumlah Papan:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.jumlahPapan)}</span>
                </div>
                <div class="flex justify-between gap-2">
                  <span class="text-gray-600 flex-shrink-0">Rata Per Papan:</span>
                  <span class="font-medium break-words text-right">${formatNumber(result.rataPerPapan)} lot</span>
                </div>
              </div>
              <div class="pt-3 mt-3 border-t border-gray-200 space-y-2">
                <p class="text-gray-700 break-words">
                  <span class="font-medium">Target LOW:</span> ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountLow)} = <span class="font-bold text-green-600">Rp ${formatNumber(result.targetLow)}</span>
                </p>
                <p class="text-gray-700 break-words">
                  <span class="font-medium">Target HIGH:</span> ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountHigh)} = <span class="font-bold text-blue-600">Rp ${formatNumber(result.targetHigh)}</span>
                </p>
              </div>
            </div>
          </div>
        `;
      }).join('');

      container.innerHTML = `
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold text-gray-800">Hasil Perhitungan</h2>
          <button onclick="handleClearAllHistory()" class="text-sm bg-red-100 hover:bg-red-200 text-red-600 px-4 py-2 rounded-lg transition-colors">
            Hapus semua
          </button>
        </div>
        <p class="text-sm text-gray-500 mb-4">Riwayat perhitungan tersimpan otomatis</p>
        <div class="space-y-4">${historyHTML}</div>
      `;
      container.classList.remove('hidden');
    }

    function toggleExpand(timestamp) {
      expandedItems[timestamp] = !expandedItems[timestamp];
      renderHistory();
    }

    function handleCopy(timestamp) {
      const result = history.find(r => r.timestamp === timestamp);
      if (!result) return;

      const details = [
        `Tanggal: ${result.dateDisplay}`,
        `Buy Avg: Rp ${formatNumber(result.buyAvg)}`,
        `Buy Lot: ${formatNumber(result.buyLot)} lot`,
        `Tick size: ${result.tick} poin`,
        `5% Buy Avg = ${formatNumber(result.fivePercent)} poin`,
        ``,
        `Total Bid: ${formatNumber(result.totalBid)} lot  |  Total Offer: ${formatNumber(result.totalOffer)} lot`,
        `Jumlah Papan: ${formatNumber(result.jumlahPapan)}`,
        `Rata per papan = ${formatNumber(result.rataPerPapan)} lot`,
        ``,
        `Papan terdorong = Buy Lot / Rata per Papan`,
        `  HIGH: ${formatNumber(result.papanCountHigh)} papan`,
        `  LOW: ${formatNumber(result.papanCountLow)} papan`,
        ``,
        `TARGET LOW:`,
        `  = ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountLow)}`,
        `  = Rp ${formatNumber(result.targetLow)} (+${formatNumber(result.percentLow)}%)`,
        ``,
        `TARGET HIGH:`,
        `  = ${formatNumber(result.buyAvg)} + ${formatNumber(result.fivePercent)} + ${formatNumber(result.papanCountHigh)}`,
        `  = Rp ${formatNumber(result.targetHigh)} (+${formatNumber(result.percentHigh)}%)`
      ].join('\n');

      const text = `Target Realistis untuk ${result.emiten} (Broker ${result.broker}):\nLOW: Rp ${formatNumber(result.targetLow)} | HIGH: Rp ${formatNumber(result.targetHigh)}\n\n${details}`;

      navigator.clipboard.writeText(text);
      
      const icon = document.getElementById(`copyIcon-${result.timestamp}`);
      if (icon) {
        icon.innerHTML = '<polyline points="20 6 9 17 4 12"/>';
        setTimeout(() => {
          icon.innerHTML = '<rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>';
        }, 2000);
      }
    }

    function handleDeleteHistory(timestamp) {
      try {
        history = history.filter(item => item.timestamp !== timestamp);
        localStorage.setItem('calc_history', JSON.stringify(history));
        renderHistory();
      } catch (e) {
        console.error('Failed to delete history item:', e);
      }
    }

    function handleClearAllHistory() {
      if (!confirm('Hapus semua history?')) return;
      
      try {
        localStorage.removeItem('calc_history');
        history = [];
        renderHistory();
      } catch (e) {
        console.error('Failed to clear history:', e);
      }
    }
  </script>
</body>
</html>